# ============================================================================
# Kubernetes éƒ¨ç½² Template
# ============================================================================
# 
# ðŸ“‹ åŠŸèƒ½èªªæ˜Žï¼š
#   - è‡ªå‹•åŒ–éƒ¨ç½²æ‡‰ç”¨ç¨‹å¼åˆ° Kubernetes é›†ç¾¤
#   - ä½¿ç”¨ k8s-deploy å·¥å…·æ›´æ–° kustomize overlay é…ç½®
#   - æ”¯æ´å¤šæœå‹™åŒæ™‚éƒ¨ç½²
#   - è‡ªå‹•æäº¤ç‰ˆæœ¬è®Šæ›´åˆ° Git
#
# ðŸ”§ ä½¿ç”¨æ–¹å¼ï¼š
#   jobs:
#     deploy:
#       uses: ./.github/workflows/deploy-kubernetes-tpl.yml
#       with:
#         version: "2024-11-28.abc123"
#         services: '["rs-scatter-hoarding", "rs-waggle-dance"]'
#         overlays: '["RKE2-TWTPE-LAB/rs-scatter-hoarding-lab", "RKE2-TWTPE-LAB/rs-waggle-dance-lab"]'
#         k8s-deploy-image: "myorg/k8s-deploy:v1.0.0"  # é¸å¡«
#       secrets:
#         KUBECONFIG: ${{ secrets.KUBECONFIG }}
#
# ðŸ“¦ è¼¸å…¥åƒæ•¸ï¼š
#   - version: è¦éƒ¨ç½²çš„ç‰ˆæœ¬è™Ÿï¼ˆå¿…å¡«ï¼‰
#   - services: æœå‹™åç¨±åˆ—è¡¨ï¼ŒJSON é™£åˆ—æ ¼å¼ï¼ˆå¿…å¡«ï¼‰
#   - overlays: Kustomize overlay è·¯å¾‘åˆ—è¡¨ï¼ŒJSON é™£åˆ—æ ¼å¼ï¼ˆå¿…å¡«ï¼‰
#   - k8s-deploy-image: k8s-deploy CLI å®¹å™¨æ˜ åƒï¼ˆé¸å¡«ï¼Œé è¨­ï¼šmyorg/k8s-deploy:latestï¼‰
#   - deploy-path: deploy ç›®éŒ„è·¯å¾‘ï¼ˆé¸å¡«ï¼Œé è¨­ï¼š/workspace/deployï¼‰
#   - runs_on: Runner é¡žåž‹ï¼ˆé¸å¡«ï¼Œé è¨­ï¼šubuntu-latestï¼‰
#
# ðŸ” å¿…è¦ Secretsï¼š
#   - KUBECONFIG: Base64 ç·¨ç¢¼çš„ kubeconfig æª”æ¡ˆå…§å®¹
#
# ============================================================================

name: K8s Deploy (Template)

on:
  workflow_call:
    inputs:
      version:
        description: 'Version to deploy'
        required: true
        type: string

      services:
        description: 'JSON array of service names, e.g. ["service1", "service2"]'
        required: true
        type: string

      overlays:
        description: 'JSON array of overlay paths, e.g. ["cluster/service1", "cluster/service2"]'
        required: true
        type: string

      k8s-deploy-image:
        description: 'k8s-deploy CLI container image'
        required: false
        type: string
        default: 'myorg/k8s-deploy:latest'

      deploy-path:
        description: 'Path to deploy directory'
        required: false
        type: string
        default: '/workspace/deploy'

      runs_on:
        description: 'Runner type'
        required: false
        type: string
        default: '"ubuntu-latest"'

    secrets:
      KUBECONFIG:
        required: true

jobs:
  deploy:
    runs-on: ${{ fromJSON(inputs.runs_on) }}
    
    steps:
      - name: Checkout deploy repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Prepare kubeconfig
        run: |
          mkdir -p ${{ github.workspace }}/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > ${{ github.workspace }}/.kube/config
      
      - name: Deploy Services
        run: |
          SERVICES='${{ inputs.services }}'
          OVERLAYS='${{ inputs.overlays }}'
          
          # Parse JSON arrays
          SERVICE_ARRAY=($(echo $SERVICES | jq -r '.[]'))
          OVERLAY_ARRAY=($(echo $OVERLAYS | jq -r '.[]'))
          
          # Deploy each service using k8s-deploy container
          for i in "${!SERVICE_ARRAY[@]}"; do
            SERVICE="${SERVICE_ARRAY[$i]}"
            OVERLAY="${OVERLAY_ARRAY[$i]}"
            
            echo "ðŸš€ Deploying $SERVICE with overlay $OVERLAY"
            
            docker run --rm \
              -v ${{ github.workspace }}:/workspace \
              -v ${{ github.workspace }}/.kube:/root/.kube:ro \
              ${{ inputs.k8s-deploy-image }} \
              pipeline \
                --service "$SERVICE" \
                --overlay "$OVERLAY" \
                --version "${{ inputs.version }}" \
                --deploy-path "${{ inputs.deploy-path }}"
          done
      
      - name: Commit and Push changes
        run: |
          git add deploy/
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update version to ${{ inputs.version }}"
            git push
          fi
