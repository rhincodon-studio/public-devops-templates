name: Sonar Universal Scan (Template)

on:
  workflow_call:
    inputs:
      mode:
        description: "cloud 或 selfhosted"
        type: string
        required: true

      project-key:
        description: "Sonar project key"
        type: string
        required: true

      project-name:
        description: "Sonar project name"
        type: string
        required: true

      organization:
        description: "SonarCloud 組織（cloud 模式需要）"
        type: string
        required: false

      runs_on:
        required: false
        type: string
        default: '"ubuntu-latest"'

jobs:
  sonar-scan:
    runs-on: ${{ fromJSON(inputs.runs_on) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ===============================================================
      #  Cloud 模式（SonarCloud）
      # ===============================================================
      - name: SonarCloud Scan
        if: ${{ inputs.mode == 'cloud' }}
        uses: SonarSource/sonarcloud-github-action@v2
        with:
          projectBaseDir: .
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: "https://sonarcloud.io"
          SONAR_SCANNER_OPTS: >
            -Dsonar.projectKey=${{ inputs.project-key }}
            -Dsonar.projectName=${{ inputs.project-name }}
            -Dsonar.organization=${{ inputs.organization }}

      # ===============================================================
      #  Self-hosted 模式（自架 SonarQube）
      # ===============================================================
      - name: SonarQube Scan (Self-hosted)
        if: ${{ inputs.mode == 'selfhosted' }}
        uses: SonarSource/sonarqube-scan-action@v2
        with:
          projectBaseDir: .
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}  # 你的 K8s / VM URL
          SONAR_SCANNER_OPTS: >
            -Dsonar.projectKey=${{ inputs.project-key }}
            -Dsonar.projectName=${{ inputs.project-name }}