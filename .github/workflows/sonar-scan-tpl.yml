name: Sonar Universal Scan (Template)

on:
  workflow_call:
    inputs:
      mode:
        description: "cloud 或 selfhosted"
        type: string
        required: true

      project-key:
        description: "Sonar project key"
        type: string
        required: true

      project-name:
        description: "Sonar project name"
        type: string
        required: true

      organization:
        description: "SonarCloud 組織（cloud 模式需要）"
        type: string
        required: false

      runs_on:
        type: string
        required: false
        default: '"ubuntu-latest"'

    secrets:
      SONAR_TOKEN:
        required: true
      SONAR_HOST_URL:
        required: false

jobs:
  sonar-scan:
    runs-on: ${{ fromJSON(inputs.runs_on) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Debug secret
        run: |
          echo "SONAR_TOKEN length: ${#SONAR_TOKEN}"
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      # ===============================================================
      #  Cloud 模式（SonarCloud）
      # ===============================================================
      - name: SonarCloud Scan
        if: ${{ inputs.mode == 'cloud' }}
        uses: SonarSource/sonarcloud-github-action@v2
        with:
          projectBaseDir: .
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: "https://sonarcloud.io"
          SONAR_SCANNER_OPTS: >
            -Dsonar.projectKey=${{ inputs.project-key }}
            -Dsonar.projectName=${{ inputs.project-name }}
            -Dsonar.organization=${{ inputs.organization }}
            -Dsonar.sarif.filePath=sonar-report.sarif

      # ===============================================================
      #  Self-hosted 模式（自架 SonarQube）
      # ===============================================================
      - name: SonarQube Scan (Self-hosted)
        if: ${{ inputs.mode == 'selfhosted' }}
        uses: SonarSource/sonarqube-scan-action@v2
        with:
          projectBaseDir: .
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
          SONAR_SCANNER_OPTS: >
            -Dsonar.projectKey=${{ inputs.project-key }}
            -Dsonar.projectName=${{ inputs.project-name }}
            -Dsonar.sarif.filePath=sonar-report.sarif

      # ===============================================================
      #  上傳報告 artifact（Cloud 與 Selfhosted 皆適用）
      # ===============================================================
      - name: Upload Sonar SARIF Report
        uses: actions/upload-artifact@v4
        with:
          name: sonar-report
          path: sonar-report.sarif
          if-no-files-found: warn