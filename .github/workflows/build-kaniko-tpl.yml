# ============================================================================
# Kaniko Build Template
# ============================================================================
# 
# ðŸ“‹ åŠŸèƒ½èªªæ˜Žï¼š
#   - ä½¿ç”¨ Kaniko åœ¨å®¹å™¨å…§å»ºç½® Docker æ˜ åƒï¼ˆç„¡éœ€ Docker daemonï¼‰
#   - è‡ªå‹•ç”¢ç”Ÿç‰ˆæœ¬æ¨™ç±¤ï¼ˆæ—¥æœŸ.commitï¼‰
#   - æ”¯æ´ layer caching åŠ é€Ÿå»ºç½®
#   - è¼¸å‡ºç‰ˆæœ¬è™Ÿåˆ°ç’°å¢ƒæª”æ¡ˆ
#
# ðŸ”§ ä½¿ç”¨æ–¹å¼ï¼š
#   jobs:
#     build:
#       uses: ./.github/workflows/build-kaniko-tpl.yml
#       with:
#         repository: "my-repo"
#         container_repository: "myorg/my-service"
#         working_directory: "services/my-service"
#         dockerfile_path: "Dockerfile"
#       secrets:
#         DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
#         DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
#
# ðŸ“¦ è¼¸å…¥åƒæ•¸ï¼š
#   - repository: å„²å­˜åº«åç¨±ï¼ˆå¿…å¡«ï¼‰
#   - container_repository: å®¹å™¨æ˜ åƒå„²å­˜åº«è·¯å¾‘ï¼ˆå¿…å¡«ï¼‰
#   - working_directory: å·¥ä½œç›®éŒ„è·¯å¾‘ï¼ˆå¿…å¡«ï¼‰
#   - dockerfile_path: Dockerfile ç›¸å°è·¯å¾‘ï¼ˆå¿…å¡«ï¼‰
#   - cache: æ˜¯å¦å•Ÿç”¨ layer cacheï¼ˆé¸å¡«ï¼Œé è¨­ï¼štrueï¼‰
#   - runs_on: Runner é¡žåž‹ï¼ˆé¸å¡«ï¼Œé è¨­ï¼š["self-hosted", "linux"]ï¼‰
#
# ðŸ” å¿…è¦ Secretsï¼š
#   - DOCKERHUB_USERNAME: Docker Hub ä½¿ç”¨è€…åç¨±
#   - DOCKERHUB_TOKEN: Docker Hub å­˜å–æ¬Šæ–
#
# ============================================================================

name: ðŸ”§ Kaniko Build Template

on:
  workflow_call:
    inputs:
      repository:
        description: 'Repository name'
        required: true
        type: string
      container_repository:
        description: 'Container repository path (e.g. myorg/myimage)'
        required: true
        type: string
      working_directory:
        description: 'Working directory path'
        required: true
        type: string
      dockerfile_path:
        description: 'Dockerfile relative path'
        required: true
        type: string
      cache:
        description: 'Enable layer caching'
        required: false
        type: boolean
        default: true
      runs_on:
        description: 'Runner type'
        required: false
        type: string
        default: '["self-hosted", "linux"]'
    secrets:
      DOCKERHUB_USERNAME:
        required: true
      DOCKERHUB_TOKEN:
        required: true

jobs:
  kaniko-build:
    runs-on: ${{ fromJSON(inputs.runs_on) }}

    steps:
      # --- 1ï¸âƒ£ æª¢å‡ºç¨‹å¼ç¢¼ï¼ˆåœ¨ Runner ä¸»æ©ŸåŸ·è¡Œï¼‰ ---
      - uses: actions/checkout@v4

      # --- 2ï¸âƒ£ è¨­å®š Docker Auth ---
      - name: Configure Docker Auth
        run: |
          mkdir -p ${HOME}/.docker
          echo '{"auths":{"https://index.docker.io/v1/":{"auth":"'"$(echo -n ${{ secrets.DOCKERHUB_USERNAME }}:${{ secrets.DOCKERHUB_TOKEN }} | base64)"'"}}}' > ${HOME}/.docker/config.json
          cat ${HOME}/.docker/config.json

      # --- 3ï¸âƒ£ è¨ˆç®—ç‰ˆæœ¬è™Ÿ (æ—¥æœŸ+commit) ---
      - name: Generate Version Tag
        id: version
        run: |
          VERSION="$(date '+%Y-%m-%d').${GITHUB_SHA::8}"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "$VERSION" > version.txt
          echo "Generated version: $VERSION"

      # --- 4ï¸âƒ£ åœ¨ Runner ä¸»æ©Ÿä¸Šæ‰‹å‹• docker run Kaniko ---
      - name: Build and Push with Kaniko
        run: |
          docker run \
            -v $(pwd)/${{ inputs.working_directory }}:/workspace \
            -v $HOME/.docker:/kaniko/.docker:ro \
            gcr.io/kaniko-project/executor:v1.23.0-debug \
            --context /workspace \
            --dockerfile /workspace/${{ inputs.dockerfile_path }} \
            --destination docker.io/${{ inputs.container_repository }}:${VERSION} \
            --cache=${{ inputs.cache }} \
            --image-fs-extract-retry 5

      # --- 5ï¸âƒ£ è¼¸å‡ºç‰ˆæœ¬è™Ÿ ---
      - name: Export version
        run: |
          echo "VERSION=${VERSION}" >> "${{ inputs.repository }}.env"
          cat "${{ inputs.repository }}.env"