# ============================================================================
# Checkmarx AST SAST Scan Template
# ============================================================================
# 
# ðŸ“‹ åŠŸèƒ½èªªæ˜Žï¼š
#   - ä½¿ç”¨ Checkmarx AST é€²è¡Œéœæ…‹æ‡‰ç”¨ç¨‹å¼å®‰å…¨æ¸¬è©¦ï¼ˆSASTï¼‰
#   - æ”¯æ´è‡ªè¨‚å¤±æ•—ç­–ç•¥ï¼ˆä¾åš´é‡æ€§ç­‰ç´šè¨­å®šé–¾å€¼ï¼‰
#   - ç”¢ç”ŸæŽƒæå ±å‘Šä¸¦ä¸Šå‚³ç‚º artifact
#
# ðŸ”§ ä½¿ç”¨æ–¹å¼ï¼š
#   jobs:
#     security-scan:
#       uses: ./.github/workflows/scan-checkmarx-tpl.yml
#       with:
#         project-name: "my-project"
#         fail-policy: "high=0;medium=5"
#       secrets:
#         CX_APIKEY: ${{ secrets.CX_APIKEY }}
#         CX_TENANT: ${{ secrets.CX_TENANT }}
#
# ðŸ“¦ è¼¸å…¥åƒæ•¸ï¼š
#   - project-name: Checkmarx å°ˆæ¡ˆåç¨±ï¼ˆå¿…å¡«ï¼‰
#   - fail-policy: å¤±æ•—ç­–ç•¥ï¼Œæ ¼å¼ï¼šseverity=countï¼ˆé¸å¡«ï¼Œé è¨­ï¼šhigh=0;medium=5ï¼‰
#   - branch: åˆ†æ”¯åç¨±ï¼ˆé¸å¡«ï¼Œé è¨­ï¼šç•¶å‰åˆ†æ”¯ï¼‰
#   - runs_on: Runner é¡žåž‹ï¼ˆé¸å¡«ï¼Œé è¨­ï¼šubuntu-latestï¼‰
#
# ðŸ” å¿…è¦ Secretsï¼š
#   - CX_APIKEY: Checkmarx API é‡‘é‘°
#   - CX_TENANT: Checkmarx ç§Ÿæˆ¶åç¨±
#
# ============================================================================

name: Checkmarx AST SAST Scan (Template)

on:
  workflow_call:
    inputs:
      project-name:
        description: 'Checkmarx project name'
        required: true
        type: string

      fail-policy:
        description: 'Failure policy (e.g. high=0;medium=5)'
        required: false
        type: string
        default: "high=0;medium=5"

      branch:
        description: 'Branch name (defaults to current branch)'
        required: false
        type: string
        default: ""

      runs_on:
        description: 'Runner type'
        required: false
        type: string
        default: '"ubuntu-latest"'

jobs:
  sast-scan:
    runs-on: ${{ fromJSON(inputs.runs_on) }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set branch fallback
        id: set_branch
        run: |
          if [ -z "${{ inputs.branch }}" ]; then
            echo "branch=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT
          else
            echo "branch=${{ inputs.branch }}" >> $GITHUB_OUTPUT
          fi

      - name: Run Checkmarx AST Scan
        shell: bash
        run: |
          echo "ðŸš€ Running Checkmarx AST Scan..."

          docker run --rm \
            -e CX_APIKEY="${{ secrets.CX_APIKEY }}" \
            -e CX_BASE_URI="https://ast.checkmarx.net" \
            -e CX_TENANT="${{ secrets.CX_TENANT }}" \
            -v "${GITHUB_WORKSPACE}:/app" \
            rhincodonstudio/checkmarx-ast-cli:latest \
              cx scan create \
                --project-name "${{ inputs['project-name'] }}" \
                --branch "${{ steps.set_branch.outputs.branch }}" \
                --sast-containerized true \
                --async false \
                --threshold "${{ inputs.fail-policy }}" \
                --report --output "/app/cx-results.json"

      - name: Upload scan result
        uses: actions/upload-artifact@v4
        with:
          name: cx-results
          path: cx-results.json