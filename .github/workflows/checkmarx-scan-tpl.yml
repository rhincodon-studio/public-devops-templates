name: Checkmarx AST SAST Scan (Template)

on:
  workflow_call:
    inputs:
      project-name:
        required: true
        type: string

      fail-policy:
        required: false
        type: string
        default: "high=0;medium=5"

      branch:
        required: false
        type: string
        default: ""

      runs_on:
        required: false
        type: string
        default: '"ubuntu-latest"'   # å¿…é ˆæ˜¯ JSON æ ¼å¼å­—ä¸²ï¼ˆå«å¼•è™Ÿï¼‰

jobs:
  sast-scan:
    runs-on: ${{ fromJSON(inputs.runs_on) }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set branch fallback
        id: set_branch
        run: |
          if [ -z "${{ inputs.branch }}" ]; then
            echo "branch=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT
          else
            echo "branch=${{ inputs.branch }}" >> $GITHUB_OUTPUT
          fi

      - name: Run Checkmarx AST Scan
        shell: bash
        run: |
          echo "ðŸš€ Running Checkmarx AST Scan..."

          docker run --rm \
            -e CX_APIKEY="${{ secrets.CX_APIKEY }}" \
            -e CX_BASE_URI="https://ast.checkmarx.net" \
            -e CX_TENANT="${{ secrets.CX_TENANT }}" \
            -v "${GITHUB_WORKSPACE}:/app" \
            rhincodonstudio/checkmarx-ast-cli:latest \
              cx scan create \
                --project-name "${{ inputs['project-name'] }}" \
                --branch "${{ steps.set_branch.outputs.branch }}" \
                --sast-containerized true \
                --async false \
                --threshold "${{ inputs.fail-policy }}" \
                --report --output "/app/cx-results.json"

      - name: Upload scan result
        uses: actions/upload-artifact@v4
        with:
          name: cx-results
          path: cx-results.json