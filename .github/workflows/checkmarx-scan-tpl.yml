name: Checkmarx AST SAST Scan (Template)

on:
  workflow_call:
    inputs:
      project-name:
        required: true
        type: string
      fail-policy:
        required: false
        type: string
        default: "high=0;medium=5"
      branch:
        required: false
        type: string
        default: "${{ github.ref_name }}"

jobs:
  sast-scan:
    runs-on: ${{ fromJSON(inputs.runs_on) }}

    steps:
      # 1. å–å‡ºç¨‹å¼ç¢¼
      - name: Checkout repo
        uses: actions/checkout@v4

      # 2. åŸ·è¡Œ Checkmarx AST CLIï¼ˆä½¿ç”¨ä½ çš„ Docker imageï¼‰
      - name: Run Checkmarx AST Scan
        shell: bash
        run: |
          echo "ğŸš€ Running Checkmarx AST Scan..."
          
          docker run --rm \
            -e CX_APIKEY="${{ secrets.CX_APIKEY }}" \
            -e CX_BASE_URI="https://ast.checkmarx.net" \
            -e CX_TENANT="${{ secrets.CX_TENANT }}" \
            -v "${GITHUB_WORKSPACE}:/app" \
            rhincodonstudio/checkmarx-ast-cli:latest \
              cx scan create \
                --project-name "${{ inputs['project-name'] }}" \
                --branch "${{ inputs.branch }}" \
                --sast-containerized true \
                --async false \
                --threshold "${{ inputs.fail-policy }}" \
                --report --output "/app/cx-results.json"

      # 3. ä¸Šå‚³æƒæçµæœï¼ˆå¯é¸ï¼‰
      - name: Upload scan result
        uses: actions/upload-artifact@v4
        with:
          name: cx-results
          path: cx-results.json