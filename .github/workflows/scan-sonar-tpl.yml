# ============================================================================
# Sonar Universal Scan Template
# ============================================================================
# 
# ğŸ“‹ åŠŸèƒ½èªªæ˜ï¼š
#   - æ”¯æ´ SonarCloud å’Œè‡ªæ¶ SonarQube å…©ç¨®æ¨¡å¼
#   - é€²è¡Œç¨‹å¼ç¢¼å“è³ªèˆ‡å®‰å…¨æ€§åˆ†æ
#   - ç”¢ç”Ÿ SARIF æ ¼å¼å ±å‘Šä¸¦ä¸Šå‚³ç‚º artifact
#
# ğŸ”§ ä½¿ç”¨æ–¹å¼ï¼ˆSonarCloudï¼‰ï¼š
#   jobs:
#     code-quality:
#       uses: ./.github/workflows/scan-sonar-tpl.yml
#       with:
#         mode: "cloud"
#         project-key: "my-project-key"
#         project-name: "My Project"
#         organization: "my-org"
#       secrets:
#         SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
#
# ğŸ”§ ä½¿ç”¨æ–¹å¼ï¼ˆSelf-hosted SonarQubeï¼‰ï¼š
#   jobs:
#     code-quality:
#       uses: ./.github/workflows/scan-sonar-tpl.yml
#       with:
#         mode: "selfhosted"
#         project-key: "my-project-key"
#         project-name: "My Project"
#       secrets:
#         SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
#         SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
#
# ğŸ“¦ è¼¸å…¥åƒæ•¸ï¼š
#   - mode: æƒææ¨¡å¼ï¼Œcloud æˆ– selfhostedï¼ˆå¿…å¡«ï¼‰
#   - project-key: Sonar å°ˆæ¡ˆé‡‘é‘°ï¼ˆå¿…å¡«ï¼‰
#   - project-name: Sonar å°ˆæ¡ˆåç¨±ï¼ˆå¿…å¡«ï¼‰
#   - organization: SonarCloud çµ„ç¹”åç¨±ï¼ˆcloud æ¨¡å¼å¿…å¡«ï¼‰
#   - runs_on: Runner é¡å‹ï¼ˆé¸å¡«ï¼Œé è¨­ï¼šubuntu-latestï¼‰
#
# ğŸ” å¿…è¦ Secretsï¼š
#   - SONAR_TOKEN: Sonar å­˜å–æ¬Šæ–
#   - SONAR_HOST_URL: SonarQube ä¼ºæœå™¨ç¶²å€ï¼ˆselfhosted æ¨¡å¼å¿…å¡«ï¼‰
#
# ============================================================================

name: Sonar Universal Scan (Template)

on:
  workflow_call:
    inputs:
      mode:
        description: "Scan mode: cloud or selfhosted"
        type: string
        required: true

      project-key:
        description: "Sonar project key"
        type: string
        required: true

      project-name:
        description: "Sonar project name"
        type: string
        required: true

      organization:
        description: "SonarCloud organization (required for cloud mode)"
        type: string
        required: false

      runs_on:
        description: "Runner type"
        type: string
        required: false
        default: '"ubuntu-latest"'

    secrets:
      SONAR_TOKEN:
        required: true
      SONAR_HOST_URL:
        required: false

jobs:
  sonar-scan:
    runs-on: ${{ fromJSON(inputs.runs_on) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Debug secret
        run: |
          echo "SONAR_TOKEN length: ${#SONAR_TOKEN}"
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      # ===============================================================
      #  Cloud æ¨¡å¼ï¼ˆSonarCloudï¼‰
      # ===============================================================
      - name: SonarCloud Scan
        if: ${{ inputs.mode == 'cloud' }}
        uses: SonarSource/sonarcloud-github-action@v2
        with:
          projectBaseDir: .
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: "https://sonarcloud.io"
          SONAR_SCANNER_OPTS: >
            -Dsonar.projectKey=${{ inputs.project-key }}
            -Dsonar.projectName=${{ inputs.project-name }}
            -Dsonar.organization=${{ inputs.organization }}
            -Dsonar.sarif.filePath=sonar-report.sarif

      # ===============================================================
      #  Self-hosted æ¨¡å¼ï¼ˆè‡ªæ¶ SonarQubeï¼‰
      # ===============================================================
      - name: SonarQube Scan (Self-hosted)
        if: ${{ inputs.mode == 'selfhosted' }}
        uses: SonarSource/sonarqube-scan-action@v2
        with:
          projectBaseDir: .
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
          SONAR_SCANNER_OPTS: >
            -Dsonar.projectKey=${{ inputs.project-key }}
            -Dsonar.projectName=${{ inputs.project-name }}
            -Dsonar.sarif.filePath=sonar-report.sarif

      # ===============================================================
      #  ä¸Šå‚³å ±å‘Š artifactï¼ˆCloud èˆ‡ Selfhosted çš†é©ç”¨ï¼‰
      # ===============================================================
      - name: Upload Sonar SARIF Report
        uses: actions/upload-artifact@v4
        with:
          name: sonar-report
          path: sonar-report.sarif
          if-no-files-found: warn