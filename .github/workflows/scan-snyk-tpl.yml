# ============================================================================
# Snyk Security Scan Template
# ============================================================================
# 
# ğŸ“‹ åŠŸèƒ½èªªæ˜ï¼š
#   - ä½¿ç”¨ Snyk é€²è¡Œä¾è³´å¥—ä»¶å®‰å…¨æƒæ
#   - æ”¯æ´å®¹å™¨æ˜ åƒæƒæï¼ˆé¸å¡«ï¼‰
#   - æª¢æ¸¬å·²çŸ¥æ¼æ´ä¸¦æä¾›ä¿®å¾©å»ºè­°
#
# ğŸ”§ ä½¿ç”¨æ–¹å¼ï¼š
#   jobs:
#     security-scan:
#       uses: ./.github/workflows/scan-snyk-tpl.yml
#       with:
#         image-name: "myorg/myimage:latest"  # é¸å¡«
#         org: "my-snyk-org"                  # é¸å¡«
#       secrets:
#         SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
#
# ğŸ“¦ è¼¸å…¥åƒæ•¸ï¼š
#   - image-name: å®¹å™¨æ˜ åƒåç¨±ï¼ˆé¸å¡«ï¼Œè‹¥æä¾›å‰‡åŸ·è¡Œå®¹å™¨æƒæï¼‰
#   - org: Snyk çµ„ç¹” IDï¼ˆé¸å¡«ï¼‰
#   - runs_on: Runner é¡å‹ï¼ˆé¸å¡«ï¼Œé è¨­ï¼šubuntu-latestï¼‰
#
# ğŸ” å¿…è¦ Secretsï¼š
#   - SNYK_TOKEN: Snyk API æ¬Šæ–
#
# ============================================================================

name: Snyk Scan (Template)

on:
  workflow_call:
    inputs:
      image-name:
        description: "Container image name for Snyk container scan"
        required: false
        type: string
        default: ""

      org:
        description: "Snyk organization ID"
        required: false
        type: string
        default: ""

      runs_on:
        description: "Runner type"
        type: string
        required: false
        default: '"ubuntu-latest"'

    secrets:
      SNYK_TOKEN:
        required: true

jobs:
  deps-scan:
    name: Snyk Dependency Scan
    runs-on: ${{ fromJSON(inputs.runs_on) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Snyk CLI
        uses: snyk/actions/setup@v4

      - name: Snyk Test (Dependencies)
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          snyk test \
            --all-projects \
            ${{ inputs.org && format('--org={0}', inputs.org) || '' }}

  image-scan:
    name: Snyk Container Scan
    if: inputs.image-name != ''
    runs-on: ${{ fromJSON(inputs.runs_on) }}

    steps:
      - name: Install Snyk CLI
        uses: snyk/actions/setup@v4

      - name: Snyk Container Test
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          snyk container test \
            ${{ inputs.image-name }} \
            ${{ inputs.org && format('--org={0}', inputs.org) || '' }}