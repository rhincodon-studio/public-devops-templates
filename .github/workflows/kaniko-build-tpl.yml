name: ðŸ”§ Kaniko Build Template

on:
  workflow_call:
    inputs:
      repository:
        required: true
        type: string
      container_repository:
        required: true
        type: string
      working_directory:
        required: true
        type: string
      dockerfile_path:
        required: true
        type: string
      cache:
        required: false
        type: boolean
        default: true
      runs_on:
        required: false
        type: string
        default: '["self-hosted", "linux"]'
    secrets:
      DOCKERHUB_USERNAME:
        required: true
      DOCKERHUB_TOKEN:
        required: true

jobs:
  kaniko-build:
    runs-on: ${{ fromJSON(inputs.runs_on) }}
    container:
      image: gcr.io/kaniko-project/executor:v1.23.0-debug
      options: --entrypoint ""
      volumes:
        - /kaniko/.docker:/kaniko/.docker
    steps:
      # --- 1ï¸âƒ£ æª¢å‡ºç¨‹å¼ç¢¼ ---
      - uses: actions/checkout@v4

      # --- 2ï¸âƒ£ è¨­å®š docker auth config ---
      - name: Configure Docker Auth
        run: |
          mkdir -p /kaniko/.docker
          echo '{"auths":{"https://index.docker.io/v1/":{"auth":"'"$(echo -n ${{ secrets.DOCKERHUB_USERNAME }}:${{ secrets.DOCKERHUB_TOKEN }} | base64)"'"}}}' > /kaniko/.docker/config.json
          cat /kaniko/.docker/config.json

      # --- 3ï¸âƒ£ è¨ˆç®—ç‰ˆæœ¬è™Ÿ (æ—¥æœŸ+commit) ---
      - name: Generate Version Tag
        id: version
        run: |
          VERSION="$(date '+%Y-%m-%d').${GITHUB_SHA::8}"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "$VERSION" > version.txt
          echo "Generated version: $VERSION"

      # --- 4ï¸âƒ£ ä½¿ç”¨ Kaniko å»ºç½®èˆ‡æŽ¨é€ ---
      - name: Build and Push with Kaniko
        run: |
          echo "Building ${{ inputs.container_repository }}:${VERSION}"
          /kaniko/executor \
            --context "${{ inputs.working_directory }}" \
            --dockerfile "${{ inputs.dockerfile_path }}" \
            --destination "docker.io/${{ inputs.container_repository }}:${VERSION}" \
            --cache=${{ inputs.cache }} \
            --image-fs-extract-retry 5

      # --- 5ï¸âƒ£ è¼¸å‡ºç‰ˆæœ¬è™Ÿ (æ¨¡æ“¬ GitLab dotenv artifact) ---
      - name: Export version
        run: |
          echo "VERSION=${VERSION}" >> "${{ inputs.repository }}.env"
          cat "${{ inputs.repository }}.env"