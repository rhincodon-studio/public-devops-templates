name: ðŸ”§ Kaniko Build Template (Daemonless)

on:
  workflow_call:
    inputs:
      repository:
        required: true
        type: string
      container_repository:
        required: true
        type: string
      working_directory:
        required: true
        type: string
      dockerfile_path:
        required: true
        type: string
      cache:
        required: false
        type: boolean
        default: true
      runs_on:
        required: false
        type: string
        default: '["self-hosted", "linux"]'
    secrets:
      DOCKERHUB_USERNAME:
        required: true
      DOCKERHUB_TOKEN:
        required: true

jobs:
  kaniko-build:
    runs-on: ${{ fromJSON(inputs.runs_on) }}
    steps:
      # --- 1ï¸âƒ£ æª¢å‡ºç¨‹å¼ç¢¼ ---
      - uses: actions/checkout@v4

      # --- 2ï¸âƒ£ ä¸‹è¼‰ Kaniko Binary ---
      - name: Download Kaniko Executor
        run: |
          mkdir -p /tmp/kaniko
          curl -fsSL -o /tmp/kaniko/executor \
            https://github.com/GoogleContainerTools/kaniko/releases/download/v1.24.0/executor
          chmod +x /tmp/kaniko/executor
          echo "âœ… Kaniko binary downloaded."
          /tmp/kaniko/executor version || echo "(version check skipped)"

      # --- 3ï¸âƒ£ è¨­å®š Docker ç™»å…¥ ---
      - name: Configure Docker Auth
        run: |
          mkdir -p /tmp/.docker
          echo '{"auths":{"https://index.docker.io/v1/":{"auth":"'"$(echo -n ${{ secrets.DOCKERHUB_USERNAME }}:${{ secrets.DOCKERHUB_TOKEN }} | base64)"'"}}}' > /tmp/.docker/config.json
          echo "âœ… Docker credentials configured."

      # --- 4ï¸âƒ£ å»ºç«‹ç‰ˆæœ¬è™Ÿ ---
      - name: Generate Version Tag
        id: version
        run: |
          VERSION="$(date '+%Y-%m-%d').${GITHUB_SHA::8}"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "$VERSION" > version.txt
          echo "Generated version: $VERSION"

      # --- 5ï¸âƒ£ ä½¿ç”¨ Kaniko Binary å»ºç½®èˆ‡æŽ¨é€ ---
      - name: Build and Push with Kaniko (Daemonless)
        run: |
          echo "ðŸš€ Building ${{ inputs.container_repository }}:${VERSION}"
          /tmp/kaniko/executor \
            --context "${{ inputs.working_directory }}" \
            --dockerfile "${{ inputs.dockerfile_path }}" \
            --destination "docker.io/${{ inputs.container_repository }}:${VERSION}" \
            --cache=${{ inputs.cache }} \
            --verbosity info \
            --snapshotMode redo \
            --use-new-run \
            --docker-config=/tmp/.docker \
            --image-fs-extract-retry 5

      # --- 6ï¸âƒ£ è¼¸å‡ºç‰ˆæœ¬è™Ÿæª”æ¡ˆ ---
      - name: Export version
        run: |
          echo "VERSION=${VERSION}" >> "${{ inputs.repository }}.env"
          cat "${{ inputs.repository }}.env"